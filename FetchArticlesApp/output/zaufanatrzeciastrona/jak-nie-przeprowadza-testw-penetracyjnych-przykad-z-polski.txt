Duża polska firma konsultingowa została przyłapana w trakcie swoich pentestów dla jednego z klientów. Okazuje się, że defensywa klienta była przynajmniej w części skuteczna a przy okazji pokazała, jak nie używać infrastruktury. Pewien czas temu trafiła do nas próbka czegoś, co wyglądało na całkiem niezły phishing lub APT. Im bliżej jednak się jej przyglądaliśmy, tym bardziej wyglądała nam ona na działania pentesterskie wykonywane na zlecenie – i to przez nie byle kogo, bo dużą firmę konsultingową PwC. Tydzień temu na Twitterze pojawił się ciekawy wpis wyglądający następująco:  Warto było bliżej mu się przyjrzeć. Na pierwszy rzut oka wygląda jak zwykły atak z użyciem makro w dokumencie Office.  Gdy jednak spojrzymy na to, co potrafi załączone makro, jak używa PowerShella i jak przeprowadza komunikację ze światem za pomocą rekordów DNS, sprawa staje się bardziej interesująca. Wskazuje na to dzisiejszy tweet Marcina Siedlarza, który lubi zaglądać do VirusTotal w poszukiwaniu polskich próbek.  Zacznijmy jednak od próby atrybucji. Startujemy z domeną topbrains.it.  To już mógłby być koniec procesu atrybucji – najwyraźniej rejestr domen IT utrudnia ukrycie prawdziwego podmiotu rejestrującego lub ktoś nie zwrócił na taką opcję uwagi. Co ciekawe, znakomita większość innych domen używanych przez PwC do ataków ma rekordy WHOIS całkiem przyzwoicie ukryte. Innych domen mówicie? Jakich innych domen? Odpowie na to kilka prostych wyszukiwań w VirusTotal:  Gdy sprawdzicie po kolei historię domen przypisanych do powyższych adresów IP (oraz historię adresów IP przypisanych do odkrywanych domen) to znajdziecie taką listę adresów: Jeśli któraś domena pojawia się więcej niż 1 raz, to dlatego, że była przenoszona między różnymi adresami IP. Niektóre adresy pokazują nazwy prawdopodobnych klientów, inne także wskazują na stosowane metody przekonywania pracowników atakowanej firmy do kliknięcia w załącznik – np. rankingplac.pl. Ta domena z kolei prowadzi do próbek takich jak ta czy ta, gdzie możecie pooglądać, jak prowadzona jest komunikacja tunelowana przez zapytania DNS. Prowadzenie testów penetracyjnych to ciekawe zajęcie, które zapewne wielu z naszych Czytelników daje dużo radości i satysfakcji. Warto jednak pamiętać, że po drugiej stronie także siedzą nie tylko użytkownicy klikający w każdego linka, ale też osoby podobne do pentesterów, które mogą przesłany załącznik wrzucić do VirusTotala czy Hybrid Analysis. A wtedy lepiej, by adres IP, do którego prowadzą, nie pokazywał sporej części używanego arsenału przynęt oraz domen podobnych do adresów niektórych klientów z ostatnich dwóch lat pracy… PS. Skrypty w PowerShellu i komunikacja po DNS są naprawdę fajnie zrobione.,Adam