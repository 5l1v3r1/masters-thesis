Matematyk Zachary Harris niezmiernie zdziwił się, kiedy odebrał e-maila od rekrutera z Google. Wiadomość zachęcała do rozpoczęcia procesu rekrutacji i chwaliła matematyka za zdolności programistyczne oraz znajomość Linuksa. Zachary był nieufny, bo wcale nie uważał się za Linuksowego guru… Zwęszył więc podstęp i znalazł poważną podatność na atak — nie tylko na serwerach Google. Czy to specyficzna rekrutacja do Google? Obserwując pracę niektórych rekruterów można odnieść wrażenie, że to mocno niezorientowani w branży ludzie, którzy masowo wysyłają e-maile zachęcające do pracy na stanowisku X do osób, które z wymaganiami stawianymi temu stanowisku nie mają zbyt wiele wspólnego. Ot, LinkedIn przypadkiem zwrócił odpowiedni “keyword” na ich profilu. Zachary jednak nie zignorował e-maila od rekrutera z Google, ale zaczął się zastanawiać, czy przypadkiem ta z pozoru nieadekwatna do jego zdolności propozycja nie jest elementem rekrutacji na zupełnie inne stanowisko… Matematyk zaczął więc badać źródło e-maila i zauważył w nagłówkach sygnaturę DKIM. Standard. Ale matematykowi w oczy rzuciło się, że klucz który ją wygenerował był dość krótki (512 bitów). Zachary nie sądził, żeby taka firma jak Google pozwoliła sobie na taką wpadkę, pomyślał więc że faktoryzacja tego klucza może być jego ukrytym zadaniem rekrutacyjnym (w końcu był matematykiem!). Jak pomyślał, tak zrobił. A po “złamaniu” klucza, wykorzystał go do podpisania fałszywego e-maila, wysłanego od jednego założyciela Google — Sergey’a Brina do drugiego — Larry’ego Page’a, w którym zachwalał swoją stronę internetową. Ponieważ zespoofowany przez matematyka e-mail był podpisany poprawnym kluczem, przeszedł walidację DKIM i wylądował w skrzynce odbiorczej Page’a. Google nie odpowiedziało, ale błąd naprawiło Matematyk jednak odpowiedzi się nie doczekał ale zauważył, że 2 dni później, Google zmieniło klucz wykorzystywany do DKIM na 2048 bitowy. A więc któryś z googlersów domyślił się w czym rzecz. Co gorsza, do Zacharego dotarło, że chyba jednak faktoryzacja klucza nie była zadaniem rekrutacyjnym… Jak działa DKIM? Sygnatura DKIM umieszczona w nagłówkach e-maila służy temu, aby serwer pocztowy odbiorcy mógł zweryfikować, czy e-mail rzeczywiście został wysłany przez serwery z domeny nadawcy (a nie np. zespoofowany). Weryfikacja polega na zapytaniu DNS o rekord TXT w domenie nadawcy. W rekordzie powinien znajdować się klucz DKIM pozwalający poprawnie zweryfikować sygnaturę z e-maila. Przykład sygnatury od Google: DKIM-Signature: v=1; a=rsa-sha256; c=relaxed/relaxed; d=google.com; s=20120113; h=date:from:to:message-id:subject:mime-version:content-type:content-transfer-encoding:content-disposition; bh=seTEg3wlfCeoqQt1FD54PlgMApbvE0OnzHHORyyrwlw=; b=jL/Dw06dEEleG8YQSm0ZmlMVoDzfy2g4cDWA/NceLTocnD Rzh3zpfQX91IRnu7qNAaao23+0E0nFT3NnfGuyS7gC7f17vG ZQJ2IhsW/xrJ/LQ77ogGf/dbaCLHX016mmSmNXq4oPfsoLwn O8MjnP3kj341mDNf5750WlpNPNrV2e/7ZBImBt8ZxFGMe6fX jQVlzzU2MYE+JOs1bF8KisU1sbi+kzdq8NP8qz+dvdAxbXez /7C57yPXZhkqf8iWO8Hn7y/n2ekcDXE+9bYK5cPiOZY0eUwd 1odNRF7FhmuCBIkO6LjF9/373sGIw/6fcJQ7plyhE1ExooM7 j9H7FUuw== Przykład zapytania weryfikującego: Makabra:~ pk$ host -t TXT 20120113._domainkey.google.com 20120113._domainkey.google.com descriptive text “k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAp5kQ31/aZDr eQqR9/ikNe00ywRvZBFHod6dja+Xdui4C1y8SVrkUMQQLOO49UA+ROm4e vxAru5nGPbSl7WJzyGLl0z8Lt+qjGSa3+qxf4ZhDQ2chLS+2g0Nnzi6co UpF8r” “juvuWHWXnzpvLxE5TQdfgp8yziNWUqCXG/LBbgeGqCIpaQjla A6GtPbJbh0jl1NcQLqrOmc2Kj2urNJAW+UPehVGzHal3bCtnNz55sajug Rps1rO8lYdPamQjLEJhwaEg6/E50m58BVVdK3KHvQzrQBwfvm99mHLALJ qkFHnhyKARLQf8tQMy8wVtIwY2vOUwwJxt3e0KcIX6NtnjSSwIDAQAB” Nie tylko Google podatne na spoofing Zachary zaczął testować inne domeny i to, jak implementują DKIM. Okazało się, że z (za) krótkich, 512-bitowych kluczy korzystają także eBay, Yahoo, Twitter i Amazon. Da się je “złamać” w 72 godziny w chmurze Amazonu, wydając na to 75 dolarów… Trochę mocniejsze, bo 768 bitowe klucze DKIM chroniły domeny PayPal, LinkedIn, US Bank oraz HSBC. Tych matematykowi nie udało się złamać ze względu na potrzebną do tego moc obliczeniową. Zasugerował on jednak, że państwa takie jak np. Iran mogą spokojnie sprostać temu wyzwaniu. Jak duże jest ryzyko i jak się przed nim chronić? Złamanie czyjegoś klucza DKIM umożliwia nam wysyłanie fałszywych wiadomości e-mail w czyimś imieniu. Kilka razy już mieliśmy okazję się przekonać, jak wiele daje zwykły spoofing; przypomnijmy chociażby studenta, który podszywając się pod e-mail z Kancelarii Prezydenta RP dostał pracę w TVP oraz PAP, które opublikowało fałszywą wiadomość, bo ktoś podszył się pod e-mail Beaty Kempy. Autorzy tych ataków nie mieli dostępu do kluczy DKIM, istniało więc ryzyko, że ich wiadomości zostaną odrzucone przez serwery pocztowe odbiorców (choć to zależy od ich konfiguracji). Mając klucz DKIM ofiary pod którą chcemy się podszyć, jesteśmy pewni, że e-mail trafi do skrzynki odbiorcy, a nie do spamu — DKIM to wszakże technologia wymyślona po to, aby spoofing ukrócić… Spear phishing Taki błąd w kontekście Google jest o tyle zabawny, że firma ta przecież jest właścicielem jednak z najpopularniejszych usług pocztowych — GMail. To raz, a dwa, że sfałszowanie sygnatury DKIM może mocno pomóc różnym rzezimieszkom w przeprowadzaniu ataków spear-phishing, czyli mocno spersonalizowanych prób phishingu. Ofiarą tego typu ataku Google już raz padło. Problem dotknął też RSA i kilku innych dużych firm — ale trzeba lojalnie podkreślić, że nie zawsze zabezpieczenia softwarowo-hardware’owe są w stanie sobie z nim poradzić, bo ataki wycelowane są w ludzi, a nie komputery. Dlatego warto jest inwestować w uświadamiające szkolenia pracowników — niektóre typy phishingu może wykryć tylko człowiek. Czy masz DKIM na swoim DNS? Podsumowując, sprawdźcie, czy klucze na waszych serwerach pocztowych, o ile wykorzystujecie DKIM, są odpowiedniej długości. Pamiętajcie też, aby sprawdzić DNS i usunąć przestarzałe rekordy dotyczące DKIM. Atak można bowiem przeprowadzić nawet jeśli serwer pocztowy w ogóle nie korzysta z DKIM, ale w DNS-ie pozostają resztki starej konfiguracji (tj. klucz). Z przeprowadzanych przez nas komercyjnie audytów bezpieczeństwa wynika, że bardzo często do podatności na ataki prowadzą pozostałości starej, zapomnianej bo niepotrzebnej już konfiguracji jakiegoś oprogramowania/usługi na serwerach produkcyjnych… ,Piotr Konieczny