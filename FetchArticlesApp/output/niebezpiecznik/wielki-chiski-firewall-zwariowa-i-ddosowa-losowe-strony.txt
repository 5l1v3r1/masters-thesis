Kiedy twoje serwery nagle zaczynają być zalewane połączeniami w liczbie ponad dwukrotnie wyższej, a nie publikujesz w tym czasie nagich zdjęć Kim Kardashian, to wiedz że coś się dzieje. Ostatnio nagły wzrost ruchu dotknął kilkanaście stron internetowych, a wszystkiemu winny jest błąd konfiguracyjny wielkiego chińskiego rządowego firewalla. Wielki Chiński Firewall Ludzie w Chinach mają cenzurowany dostęp do internetu. Wszystko kontroluje Wielki Chiński Firewall w skład którego wchodzą także usługi rozwiązywania nazw domenowych. Nie są to tylko własne serwery DNS, ale infrastruktura która przechwytuje odpowiedzi protokołu DNS i podmienia je na fałszywe (tzw. atak DNS poisoning). Do niedawna, kiedy ktoś chciał odwiedzić “zablokowaną” stronę internetową, był przekierowywany na nieistniejący adres IP. Jednak kilkanaście dni temu Wielki Chiński Firewall zmienił swoją taktykę — ruch zaczął kierować na losowe serwery; niektóre dość boleśnie odczuły 56 Mbitów dodatkowego ruchu na sekundę. Najwyraźniej Chińczyków chcących odwiedzać zakazane strony jest całkiem sporo… Jedną z ofiar firewallowego wariatctwa był Craig Hockenberry. Oto wykres z okresu ataku: Analiza logów wykazała, że większość ruchu pochodziło z Chin i odwoływało się do zasobu /announce (czyli trackera Bittorrent), a pozostała część żądań wyglądała, jakby dotyczyła nie serwera Craiga a popularnych usług CDN-owych wspierających infrastrukturę Facebooka, YouTube czy Twittera. Jak walczyć z Wielkim Chińskim Firewallem? Craig najpierw ustawił domyślny vhost w konfiguracji Apache (aby zwiększyć wydajność serwera, który musiał robić reverse lookupy dla każdego z niepoprawnych nagłówków Host:, kiedy ich wartości nie znajdował w konfiguracji). To jednak nie pomogło, więc Craig przeszedł do ostrzejszej metody — blokady adresów IP z Chin. W tym celu stworzył poniższy skrypt. #!/bin/sh # cn.zone comes from http://www.ipdeny.com/ipblocks/ # # build the rules with: # # $ build_rules > /tmp/china_rules # # apply rules with: # # $ sudo ipfw /tmp/china_rules r=1100 while read line; do echo "add $r deny ip from " $line " to any in"; r=$(( $r + 1 )) done < cn.zone Odpowiednie wskazówki dla iptables znajdziecie tutaj, a dla tych, którzy korzystają z ngnix proponujemy, skonfigurować serwer by odpowiadał kodem 410 z odpowiednią instrukcją, którą zrozumieją klienty (i nie będą nas więcej nękać): server { location /announc { access_log off; error_log off; default_type text/plain; return 410 "d14:failure reason13:not a tracker8:retry in5:nevere"; } } Na marginesie, okazuje się, że wstrzyknięcie fałszywego peera (w kliencie takim jak uTorrent można bardzo łatwo dodać do torrenta dowolny adres IP rzekomego trackera) w popularnych plikach powoduje, że peer-ofiara bardzo szybko może zostać zaDDoS-owany… DDoS-em z Wielkiego Firewalla oberwała także Korea Żeby było ciekawiej, wśród błędnych adresów IP na jakie przekierowywał chiński firewall znalazł się także serwer należący do rządu Korei i niemiecka strona pornograficzna — co w pewien sposób jest dowcipne, bo chiński firewall cenzuruje też pornografię… Pomylonych adresów i przypadkowych ofiar jest więcej. Z czego wynikają te ataki? Obserwatorzy cenzury w Chinach sugerują, że zmiana w konfiguracji chińskiego firewalla dotyczyła próby sparaliżowania programów antycenzorskich, z których nagminnie korzystają bardziej świadomi i żądni wolnego internetu Chińczycy. Programy te “wkraczają do akcji” kiedy wykryją odpowiedź DNS kierującą na jeden z błędnych adresów IP, które do tej pory wykorzystywał w przekierowaniach Chiński Firewall. Teraz część z programów antycenzorskich nie działa, ponieważ Firewall przekierowuje użytkowników na inne (nieprawdziwe, ale poprawne) adresy IP. Co ciekawe, w kilka dni po “zwariowaniu” chińskiego firewalla nastąpiła spora awaria internetu w Chinach, wynikająca najprawdopodobniej z ludzkiego błędu. Wszystkie strony (a nie tylko te cenzurowane) były przekierowywane na adres IP 65.49.2.178, pod którym działała strona grupy Falun Gong. Być może Chiński rząd chciał zablokować dostęp do tego adresu, ale na skutek pomyłki przekierował cały ruch na ten adres IP? ,vi.curry