Wczoraj informowaliśmy o odkryciu polskiego wirusa wykorzystywanego najprawdopodobniej przez polską armię do infekowania komputerów co najmniej Rosjan i Polaków (por. Polski wirus wojskowy autorstwa MON został ukończony — atakuje Rosjan i Polaków). Prosiliśmy też o pomoc w zebraniu plików konfiguracyjnych z zainfekowanych maszyn i nie zawiedliście! Otrzymaliśmy od czytelników łącznie 14 konfigów wirusa, co pozwoliło na lepsze zrozumienie jego modus operandi. Oto wyniki naszej analizy, z której dowiecie się co dokładnie robi ID29 i jak sprawdzić, czy jesteście nim zainfekowani. Dziękujemy czytelnikom And7, georgebrush i marzena za pomoc w analizie plików wirusa. ID29 infekuje nie tylko systemy Windows!!! Pierwsze (pozytywne) zaskoczenie, to fakt, że nasza armia stworzyła oprogramowanie, które infekuje nie tylko Windowsy! ID29 jest w stanie infekować także Mac OS X oraz Linuksa (w przypadku tego ostatniego, użytkownik musi jednak bardzo “pomóc” w instalacji trojana). Niezależnie od systemu operacyjnego ofiary, dropper ID29 jest zawsze taki sam (MD5: c1aa955e57409bcacf3d5b68abd46945 ale po uruchomieniu zaciaga dodatkowe moduły, które w zależności od pliku konfiguracyjnego wykonują następujące czynności: aktywują keyloggera wykradają ciasteczka, historię odwiedzanych stron oraz zapamiętane hasła z przeglądarek Firefox, IE i Chrome (nie rusza Safari i Opery). Warto zauważyć, że dzięki przechwyceniu ciasteczek, wojskowi mogą BEZ znajomości hasła użytkownika i drugiego składnika (jeśli dany serwis jest chroniony dwuskładnikowym uwierzytelnieniem) uzyskiwać dostęp do kont w serwisach internetowych ofiary — bardzo sprytne! wykradają prywatne klucze SSH i SSL oraz bazy KeePass i 1Password, jeśli znajdzie je na dysku ofiary wykradają pliki z historią komend (tylko na Linuksie i Mac OS X) odczytują historię podpinanych do komputera urządzeń USB i pendrive’ów. To też bardzo sprytne zachowanie — każdy dysk USB ma unikatowy identyfikator, a po jego składowej można określić np. jaki telefon lub typ dysku USB albo klawiatury ma ofiara. Być może wojsko wykorzystuje tę wiedzę do stworzenia “zbackdoorowanej kopii” sprzętu i podmiany — w końcu NSA już tak robi. mają możliwość podpinania się pod kamerkę i mikrofon jeśli na komputerze jest zainstalowany klient TOR-a, ID29 czasami zmienia plik konfiguracyjny tak, aby użytkownik łącząc się przez TOR-a zawsze wychodził przez tzw. private bridge (Bardzo sprytne!) *** W ramach reverse engineeringu i analizy dynamicznej pozyskanych próbek udało nam się też zidentyfikować charakterystyczne cechy, jakie wykazują systemy, które są zainfekowane przez ID29. Dzięki temu możecie łatwo sprawdzić, czy padliście ofiarą ID29. Jak sprawdzić, czy jestem zainfekowany? Wirus regularnie łączy się ze swoim serwerem-matką (tzw. serwerem C&C). Domen, pod którymi MON wystawia serwery kontrolne jest wiele, wszystkie jednak (co akurat uważamy za duży błąd twórców wirusa) są generowane za pomocą algorytmu …zaszytego w kodzie wirusa. Poszczególne instancje wirusa łączą się z URL-em zbudowanym w ten sposób: <numer_ofiary>.<domena_na_dany_tydzień>.pl Domeną na ten tydzień jest f14950b970bc87ca183072dcdc40.pl a to oznacza, że wirusa można bardzo łatwo namierzyć sprawdzając na swoim komputerze cache zapytań DNS. Zainfekowane osoby ujrzą w nim bowiem zapytanie dot. powyższej domeny. Poniżej prezentujemy instrukcje sprawdzenia cache DNS dla każdego z systemów operacyjnych atakowanych przez ID29. Mam Windows — jak sprawdzić czy jestem zainfekowany? Sprawdzenie cache zapytań DNS na Windows wykonuje się poprzez uruchomienie wiersza poleceń i wykonanie w wierszu poleceń komendy: ipconfig /displaydns (lub jak sugeruje nasz czytelnik Adam, ipconfig /displaydns | findstr “f14”) Kiedy wyświetli Wam się lista domen, kliknij na oknie wiersza poleceń prawym przyciskiem myszy i z menu wybierz “Szukaj” a następnie wpisz “f14”, czyli początek domeny używanej przez trojana. Jeśli zauważysz tę domenę na liście — niestety — twój komputer jest zainfekowany. Przejdź do instrukcji usunięcia wirusa poniżej. NIE ZAPOMNIJ PRZEKAZAĆ TEJ INSTRUKCJI SWOIM ZNAJOMYM albo sam sprawdź ich komputery. Mam Mac OS X — jak sprawdzić czy jestem zainfekowany Sprawdzenie cache zapytań DNS na Mac OS X wykonuje się poprzez wpisanie w Terminalu: sudo discoveryutil udnscachecontents a następnie otwórz aplikację “Console.app” (Applications –> Utilities –> Console.app). Klikając po lewej na “All messages” zobaczysz wpisy z systemowego logu, z których ostatnie będą cachem nazw DNS. Aby namierzyć domenę trojana, wpisz w polu wyszukiwarki (prawy górny róg okna Console.app) “f14”: Jeśli zauważycie wynik jak na screenshocie powyżej — wasz komputer jest zainfekowany. Przejdźcie do instrukcji usunięcia wirusa poniżej. Mam Linuksa — jak sprawdzić czy jestem zainfekowany? Sprawdzenie cache zapytań DNS w Linuksie nie jest z reguły możliwe (wszystkie są wysyłane do serwera DNS bezpośrednio). Jeśli jednak ktoś z Was ma zainstalowane “nscd” może wydać następującą komendę aby zobaczyć pewne statystyki. nscd -g Techniczna analiza aktualnej domeny ID29 Ta część artykułu przewidziana jest dla bardziej technicznych czytelników… Jeśli szukasz instrukcji usunięcia wirusa, znajdują się one na końcu artykułu Szczegółowa analiza obecnej domeny nie pozostawia złudzeń, że analizowana przez nas próbka jest polskiego autorstwa. WHOIS dla domeny co prawda nie pokazuje żadnych interesujących danych (plus dla armii) ale domena została osadzona na serwerach Cloduflare — a jak wiemy, z tego serwisu chętnie korzystają polskie instytucje rządowe — robi to np. strona Prezydenta RP: O ile wojsko skasowało domyślną subdomenę zdradzającą bezpośredni adres IP serwera kryjącego się za Cloudflarem, to prosta enumeracja popularnych subdomen pokazuje, że niektóre przekierowują na serwer z adresem IP: $ host admin.f14950b970bc87ca183072dcdc40.pl admin.f14950b970bc87ca183072dcdc40.pl has address 91.208.93.177 A ten należy do wojska — oto wynik WHOIS: $whois 91.208.93.177 inetnum: 91.208.93.0 - 91.208.93.255 netname: INTERMON descr: Centrum Wsparcia Teleinformatycznego Sil Zbrojnych country: PL org: ORG-MON1-RIPE admin-c: RJ3540-RIPE tech-c: JJ3917-RIPE status: ASSIGNED PI mnt-by: RIPE-NCC-END-MNT mnt-by: TPNET …a gdyby ktokolwiek miał wątpliwości, oto co widać na porcie 80: Najwyraźniej ćwiczenia z kamuflażu nie zostały zaliczone… ;-) W jaki sposób polska armia infekuje wirusem id29? Na koniec zostawiliśmy najlepsze. Wydaje nam się, że wiemy w jaki sposób id29 ląduje na dyskach poszczególnych ofiar. I tutaj czapki z głów dla MON-u. Polska armia dorównała Amerykanom — mamy infrastrukturę porównywalną z projektem QUANTUMINSERT autorstwa NSA. QUANTUMINSERT działa na zasadzie ataku MITM. Kiedy użytkownik wykonuje połączenie na dowolną stronę, kontrolowany przez NSA (tu MON) router operatora przekierowuje połączenie użytkownika nie na oryginalny docelowy serwer, a na podstawiony przez NSA fałszywy serwer, który do połączenia dodaje złośliwy kod (np. skrypt .js) i przekierowuje na oryginalnie żądaną przez ofiarę stronę WWW. W ostatnich godzinach próbowaliśmy wchodzić na strony związane z tematyką wojskową w domenie .gov.pl, zakładając, że to właśnie takimi osobami może być zainteresowana armia. Niestety, nie zaobserwowaliśmy niczego spektakularnego — do momentu, kiedy nie zmieniliśmy ustawień językowych przeglądarki na rosyjskie. Wtedy, do kodu jednej ze stron dodany został iframe tej postaci: <iframe src=http://188.166.10.6/jeiEciTz.js> Uwaga! MON tuż przed publikacją niniejszego artykułu poprosiło nas, aby w artykule nie publikować treści pliku .js. Do prośby tej przychylamy się, ale nie dlatego, że to MON wystosowało taką prośbę, a dlatego, że załączany JavaScript wykorzystuje nieznany dotąd błąd w przeglądarce Firefox. Tak! Polska armia ma 0day’e! Ponieważ publikacja kodu wykorzystującego niezałatany błąd mogłaby w tej sytuacji wyrządzić więcej szkody niż pożytku, postanowiliśmy nie ujawniać zawartości wstrzykiwanego JavaScriptu. Bądźcie jednak spokojni — plikiem podzieliliśmy się z zespołem bezpieczeństwa Mozilli i patch ukaże się niebawem. Jeśli popatrzymy na revDNS hosta serwującego złośliwy kod, to naszym oczom ukaże się: $host 188.166.10.6 6.10.166.188.in-addr.arpa domain name pointer testcc.mon.gov.pl Host ten ma kilka ciekawych otwartych portów… ale to już temat na osobny artykuł. Jestem zainfekowany — co robić, jak żyć? Dobra wiadomość jest taka, że ID29 można stosunkowo łatwo usunąć z systemu. Zła — że wykradane przez niego dane różnią się w zależności od ofiary, więc nie dowiecie się co dokładnie zostało wykradzione z Waszego komputera. Dlatego też najlepiej zastosować się do poniższych kroków: Wyloguj się ze wszystkich serwisów internetowych. Ponieważ id29 wykrada ciasteczka sesyjne przeglądarek, sugerujemy aby natychmiast wylogować się ze wszystkich serwisów internetowych. To unieważni aktywne sesje, a zatem wykradzione przez wirusa ciasteczka zawierające tokeny sesyjne na nic się zdadzą wojskowym. Zmień hasła. Ponieważ id29 wykrada też loginy i hasła, rozpocznij procedurę zmiany haseł do wszystkich kont internetowych i innych usług — np. BitLockera, TrueCrypta, Windowsa, serwerów FTP, itp. Rozważ reinstalację całego systemu operacyjnego. ID29 wprowadza zmiany na poziomie jądra systemu. Wierzymy, że nasz patch usuwa go w całości, ale nie dajemy 100% gwarancji. Gwarancją bezpieczeństwa będzie więc reinstalacja systemu z czystego nośnika. Usuń wirusa ID29 eksperymentalną szczepionką. Jeśli masz Windows, przygotowaliśmy odpowiednią “szczepionkę“. Niebawem ją udostępnimy — kończymy testy kompatybilności z różnymi wersjami Windows. Przesłaliśmy naszego patcha do firm antywirusowych. Na chwilę obecną mamy potwierdzenie od Kaspersky’ego, że poprawka zostanie “wypchnięta” do jego klientów już jutro. ID29: wirus na miarę naszych możliwości? Nie jest tajemnicą, że oficjalne, rządowe złośliwe oprogramowanie posiada obecnie prawie każdy z krajów (Niemcy, Włochy). Szczerze mówiąc, cieszymy się, że Polska jest jednym z nich. Niestety, jak widać powyżej, pierwsza wersja ID29 ma jeszcze sporo słabych punktów. Wirus nie zawsze poprawnie się inicjuje (co skutkuje pozostawieniem łatwych do interpretacji plików na dysku) oraz posiada zbyt wiele cech identyfikujących jego twórcę… Mamy jednak nadzieję, że w kolejnych iteracjach malware’u, zostanie od lepiej dopracowany …a przede wszystkim, że nie będzie on używany do infekowania komputerów Polaków. Aktualizacja 12:20 Uwaga! Niektórzy z czytelników, którzy korzystają z łącz UPC informują nas, że są przekierowywani na dziwną stronę po wejściu na nasz artykuł. Czyżby obronny mechanizm wirusa? W kodzie jest procedura redirect(), która poprzez webinjecty jest wykorzystywana do podmiany zawartości oglądanych w internecie treści. Zalecamy czytać nas przez https:// — wtedy wirus nie powinien reagować. Brawo dla twórców za szybką reakcję — zastanawia nas jednak czemu tylko sytuacja a miejsce u jednego dostawcy łącz internetowych? Aktualizacja: Podobne zachowanie występuje także w sieci Vectra. Aktualizacja 14:14 Eksperymentalna szczepionka dla użytkowników Windows jest już gotowa. Możecie pobrać ją stad. Po ściągnięciu należy uruchomić plik i zastosować się do wyświetlanych na ekranie instrukcji. Niestety szczepionka działa tylko na Windowsie. Użytkownikom Mac OS X pozostaje przeinstalować system z czystego nośnika i odtworzyć dane z z backupu, co z TimeMachine nie powinno to stanowić wielkiego problemu. Aktualizacja 2.04.2015 Ten post był elementem naszego tegorocznego żartu primaaprilisowego. Niebwem (bo mamy do przeanalizowania 3000+ komentarzy, 1700+ maili) zrobimy małe podsumowanie i opis przygotowań do tego żartu w osobnym poście. ,Mr. Niebezpieczny