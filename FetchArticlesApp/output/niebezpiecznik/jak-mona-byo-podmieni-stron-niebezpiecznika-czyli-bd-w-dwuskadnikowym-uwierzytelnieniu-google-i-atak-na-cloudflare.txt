Grupa UGNazi mogła podmienić treści widziane przez internautów po wpisaniu w przeglądarkę domeny Niebezpiecznik.pl. Jednak zamiast nas, atakujący na cel wybrali sobie bardziej znaną stronę — 4Chan.org… Cloudflare (outsourcing DNS-ów) Zarówno Niebezpiecznik, 4Chan jak i kilkanaście tysięcy innych stron internetowych korzysta z CDN-ów Cloudflare’a do serwowania statycznego contentu (obrazki, skrypty js, css). Wszystkie wasze requesty, zamiast trafiać na nasz fizyczny serwer lecą najpierw do chmury, na adresy IP należące do serwerów Cloudflare znajdujących się najbliżej waszej fizycznej lokalizacji. Adresy te podawane są przeglądarkom przez DNS Cloudflare, a żeby korzystać z usług Clodflare’a należy ustawić primary i secondary DNS na ich serwery. Mając dostęp do danego konta klienta Cloudflare’a — co oczywiste — można przekierować domenę na dowolny adres IP. I w ten właśnie sposób “zdeface’owano” 4Chana. Ale ponieważ atakujący mogli kontrolować dowolny wpis w DNS-ach Cloudflare’a, mogli także podmienić adres IP dla domeny Niebezpiecznik.pl. Warto tu podkreślić, że tymczasowe przekierowanie domeny na inny IP korzystając z podatności u dostawcy usług DNS (tu: Cloudflare oraz jak się później okazało także Google) nijak ma się do włamania na faktyczne, fizyczne serwery 4Chana czy też Niebezpiecznika. Ale po kolei… Po pierwsze: Słabości w dwuskładnikowym uwierzytelnieniu od Google Matthew Prince to szef Cloudflare’a. Cloudflare korzysta z Google Apps dla poczty. UGNazi zdobyli dostęp do korporacyjnej skrzynki mailowej Prince’a na Google Apps, chronionej przez 2 składnikowe uwierzytelnienie. Wait, WHAT!? Jak można pokonać dwuskładnikowe uwierzytelnienie!? Otóż UGNazi wykorzystali pewną “słabość” — błąd potwierdza Google: Błąd polegał na tym, że jeśli konto administratora domeny chronione przez dwuskładnikowe uwierzytelnienie było skonfigurowane w taki sposób żeby wysyłać instrukcje resetu hasła na “secondary e-mail”, to “odzyskanie” konta administratorskiego przez “secondary e-mail” automatycznie wyłączało na koncie administratora dwuskładnikowe uwierzytelnienie. Krótko mówiąc, jeśli ktoś kontrolował “secondary e-mail” dla administratora domeny Google Apps, mógł spowodować wyłaczenie 2 factor autentication. Wystarczyło zainicjować reset hasła. W przypadku Prince’a, secondary e-mailem był prywatny e-mail na GMailu, który nie wykorzystywał 2 factor authentication. A jak UGNazi przejęli prywatnego GMaila Prince’a? Byli w stanie przekonać AT&T, operatora telefonu Prince’a, do tego aby przekierować jego pocztę głosową na inny numer. Google umożliwia reset hasła poprzez wysłanie SMS-a lub odebranie połączenia telefonicznego na powiązanym ze swoim kontem telefonie. W skrócie, oznacza to tyle, że jeśli powiązałeś z kontem Google swój telefon, a atakujący zna jego numer, to bezpieczeństwo twojej skrzynki mailowej jest wprost proporcjonalne bezpieczeństwa PIN-u jaki ustawiłeś na wejściu do poczty głosowej. Atakujący bowiem może zespoofować twój numer telefonu i odsłuchać twoją pocztę głosową. Po drugie: poczta głosowa jest niezdrowa Prince przypomina sobie, że ktoś do niego dzwonił w piątek, ale ponieważ nie znał numeru, przerzucił go na pocztę głosową. 2 minuty później otrzymał wiadomość z poczty głosowej, że jego hasło do konta Google zostało zmienione. Prince zainicjował więc procedurę odzyskania hasła. UGNazi też. I tak przejmowali między sobą skrzynkę ok. 10 razy. Dopiero wieczorem, po informacji od znajmego, który próbując się dodzwonić do Prince’a usłyszał dziwne rzeczy, Prince zdał sobię sprawę, że ktoś przekierował jego pocztę głosową. A teraz najlepsze. PIN do poczty głosowej Prince ustawił sobie na 24 losowe cyfry. Nikłe są więc szanse, że UGNazi zgadli PIN. Bardziej prawdopodobne, że po prostu korzystając z socjotechniki przekonali pracownika sieci GSM do przekierowania skrzynki na którą trafiają nagrania z poczty głosowej. Po trzecie: Cloudflare sam strzelił sobie w kolano No dobra, ale jakim cudem dostęp do skrzynki prezesa Cloudflare’a daje możliwość sterowania kontami wszystkich klientów? No właśnie… tu dochodzimy do momentu, w którym okazuje się, że w tym ataku nie tylko Google dało ciała (błąd w logice biznesowej polegający na usunięciu 2 factor authentication po resecie hasła), nie tylko AT&T dało ciała (przekierowanie numeru poczty głosowej), ale ciała dał także Cloudflare. Na jedną ze skrzynek w Google Apps (do której UGNazi miało dostęp bo mając konto Prince’a miało uprawnienia administratora domeny) forwardowane były wszystkie e-maile resetu haseł do kont klientów Cloudflare’a. Cloudflare twierdzi, że w celu monitoringu… A więc coś co miało być funkcją “podnoszącą” bezpieczeństwo klientów, zadziałało na ich niekorzyść. Jak się zabezpieczyć? Cloudflare podjęło decyzję o usunięciu wszystkich numerów telefonów jako metod odzyskania/resetu hasła dla kont Google. My dodajmy tylko tyle, że usuniecie telefonów z kont Google nie uniemożliwia wykorzystania 2 składnikowego uwierzytelnienia — Google udostępnia bowiem podwójne uwierzytelnienie nie tylko via SMS/telefon, ale również poprzez osobną aplikację generującą tokeny. Aplikację można pobrać na iPhone’a, Androidy oraz Blackberry i korzystać z niej “offline” bez spinania telefonu z kontem Google. PS. Aha, UGNazi osiągnęli swój cel i jedyne co zrobili to przekierowali domenę 4Chana na ich konto Twitterowe. Ale nawet tak bzdurne uwieńczenie tych zabaw nie umniejsza tak fajnego wektora ataku… Na marginesie, poważniejszym efektem działań UGNazi było opisywane przez nas niedawno włamanie i wyciek danych z popularnego systemu billingowego WHCMS. ,Piotr Konieczny